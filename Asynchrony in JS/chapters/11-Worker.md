## Web Worker

Web Worker средство для запуска скриптов в фоновом потоке, отличном от основного потока. Каждый Web Worker имеет свой собственный цикл событий. Следовательно задачи, выполняемые ими, не блокируют цикл событий. Поэтому они отлично подходят для выполнения тяжелых в вычислительном плане и длительности задач.
Web Worker'ы не являются частью JavaScript. Они представляют собой возможность браузера, к которой можно получить доступ посредством JavaScript.

У Веб-воркеров есть некоторые ограничения:
* Веб-воркеры выполняются в изолированных потоках в браузере. Как результат, код, который они выполняют, должен быть включён в отдельный файл.
* Веб-воркеры не имеют доступ к DOM-дереву.
* У них не определен объект window, в контексте воркера и self, и this, указывают на глобальное пространство имён для воркера.
* При передаче сообщения между основным потоком и потоком worker-а, сообщение копируется или передаётся (для Transferable объектов), а не делится между потоками.

### Создание воркера

```javascript
    const worker = new Worker(aURL [, options]);
```

* aURL - URL-адрес скрипта который будет выполняться. Он должен подчиняться политике одного источника.
* options (необязательный) - объект с опциями

### Передача сообщений в/из выделенного worker
Чтобы передать сообщение в выделенный воркер, нужно вызвать на нем метод *postMessage*

```javascript
    worker.postMessage(message, [transfer]);
```

* message - объект передаваемый в worker. Будет содержаться в поле data.
* transfer (необязательный) - массив с передаваемыми Transferable объектами (из тех, что были указаны в message) на которые передаются права собственности. Если право на объект передаётся, он становится непригодным в контексте, из которого был отправлен, и становится доступным только в worker, которому он был отправлен.

Внутри воркера сообщения наружу передаются точно также.

Чтобы получить переданное сообщение в воркере, нужно подписаться на событие *message*

```javascript
    self.addEventListener('message', function(e) {
        // e.data - message, переданный в воркер
        // self.postMessage(message); - передать данные наружу
    });
```

Чтобы снаружи получить переданное из воркера сообщение, нужно на воркере подписаться на событие *message*

```javascript
    worker.addEventListener('message', function(e) {
        // e.data - message, переданный из воркера
    });
```

Чтобы обработать ошибку, возникшую в процессе выполнения воркера, используется подписка на событие *error*

```javascript
    worker.addEventListener('error', function(e) {
        e.filename — имя файла со скриптом, в котором ошибка произошла.
        e.lineno — номер строки в файле, в котором произошла ошибка.
        e.message — cообщение об ошибке в читаемом виде.
    });
```

### Завершение работы worker-а
    
Прикращение работы воркера из главного потока происходит вызовом метода *terminate* на экземпляре выделенного воркера.

```javascript
    worker.terminate();
```
    
Прикращение работы воркера внутри воркера происходит вызовом метода *close*.

```javascript
    self.close();
```

Вернемся к первому примеру из начала курса

```javascript
    let i = 0;
    const start = Date.now();
    function increment() {
        for (let j = 0; j < 1e9; j++) {
            i++;
        }
        return `Выполнено за ${(Date.now() - start) / 1000} секунд`;
    }
    console.log(increment());
```

С помощью веб воркера можно просто выполнить данный скрипт без блокирования основного потока.
Перенесем данный код в отдельный файл и поместим вызов функции *increment* внутрь обработчика *message*
Вот так:

```javascript
    // myWorker.js

    let i = 0;
    const start = Date.now();

    function increment() {
        for (let j = 0; j < 1e9; j++) {
            i++;
        }
        return `Выполнено за ${(Date.now() - start) / 1000} секунд`;
    }

    self.addEventListener('message', function(e) {
        if (e.data.cmd === 'calculate') {
            const result = increment(); // выполняем вычисления
            self.postMessage(result); // отправляем результат
            self.close(); // завершаем работу
        }
    });
```

В основном потоке создадим воркер и дадим команду на выполнение данных вычислений:

```javascript
    const worker = new Worker('./myWorker.js');

    worker.addEventListener('message', function(e) {
        console.log(e.data);
    });

    worker.postMessage({cmd: 'calculate'});
```